#!/bin/bash

LOG="/opt/om/nginx/logs/access.log"

EVIL_URI_REGEX='(wp-login\.php|zabbix|xmldata|dns-query|status\.php|sugar_version\.json|/aab9|/aaa9|cgi-bin|\.jsp|\.axd|login\.do)'

echo "===================================================="
echo "🛡  Nginx 502 阵地态势分析"
echo "📄 日志文件: $LOG"
echo "🕒 时间: $(date)"
echo "===================================================="

########################################
# 1. 502 总请求数
########################################
TOTAL_502=$(awk '$9==502' "$LOG" | wc -l)
echo
echo "📊 502 总请求数: $TOTAL_502"

########################################
# 2. 502 唯一 IP 数量（不刷屏）
########################################
UNIQUE_502_IP=$(awk '$9==502 {print $1}' "$LOG" | sort -u | wc -l)
echo "👥 502 唯一 IP 数量: $UNIQUE_502_IP"

########################################
# 3. Top 502 攻击 IP（只显示前 10）
########################################
echo
echo "🔥 Top 502 攻击 IP（前 10）"
echo "------------------------------------"
awk '$9==502 {print $1}' "$LOG" \
| sort | uniq -c | sort -nr | head -10

########################################
# 4. 命中恶意 URL 的 502 请求
########################################
echo
echo "🧨 命中恶意 URL 的 502 行为（IP + URL）"
echo "------------------------------------"
grep -E " $EVIL_URI_REGEX" "$LOG" \
| awk '$9==502 {print $1, $7}' \
| sort | uniq -c | sort -nr | head -15

########################################
# 5. 恶意 URL 命中 IP 排名
########################################
echo
echo "🚫 恶意 URL 命中 IP（Top 10）"
echo "------------------------------------"
grep -E " $EVIL_URI_REGEX" "$LOG" \
| awk '$9==502 {print $1}' \
| sort | uniq -c | sort -nr | head -10

########################################
# 6. 疑似扫描集群（/24 网段）
########################################
echo
echo "🧱 疑似扫描网段（/24，出现次数 ≥ 5）"
echo "------------------------------------"
awk '$9==502 {
  split($1,ip,".");
  print ip[1]"."ip[2]"."ip[3]".0/24"
}' "$LOG" \
| sort | uniq -c | sort -nr | awk '$1>=5' | head -10

########################################
# 7. 结论提示
########################################
echo
echo "📌 判断建议:"
echo " - 单 IP 502 ≥ 10           → 可直接封"
echo " - 多 IP 同 /24 集群扫描   → 封段"
echo " - 命中登录 / 管理 / 扫描 → 非误伤"
echo "===================================================="
